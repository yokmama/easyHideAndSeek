# Feature Specification: Disguise System (偽装システム)

**Feature Branch**: `002-disguise-system`
**Created**: 2025-11-03
**Status**: Draft
**Input**: User description: "偽装システムの実装 - ハイダーがブロックに変装して隠れる機能"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Basic Disguise Activation (Priority: P1)

ハイダーがショップGUIからブロックを選択して偽装状態になり、完全に透明化して隠れることができる。

**Why this priority**: これは偽装システムの核心機能であり、かくれんぼゲームの中心メカニクスです。この機能がなければゲームが成立しません。

**Independent Test**: ハイダーとしてゲームに参加し、`/hs shop`コマンドでショップを開き、任意のブロックを選択することで、プレイヤーが透明化し足元にブロックが設置されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ハイダーがゲーム中である、**When** `/hs shop`コマンドを実行しブロック（例：石）を選択する、**Then** プレイヤーの足元に選択したブロックが設置され、プレイヤーは完全に透明化（不可視状態）になる
2. **Given** ハイダーがゲーム中である、**When** ショップGUIで異なる種類のブロック（土、木、砂など）を選択する、**Then** それぞれのブロックタイプで正しく偽装できる
3. **Given** ハイダーが偽装中である、**When** 他のプレイヤー（シーカーやハイダー）が近づく、**Then** 偽装ブロックのみが見え、プレイヤー本体は完全に見えない
4. **Given** ハイダーがゲーム中である、**When** 既に別のプレイヤーが偽装している位置で偽装を試みる、**Then** エラーメッセージが表示され偽装できない

---

### User Story 2 - Disguise Deactivation on Movement (Priority: P1)

ハイダーが偽装中に一歩でも動くと、即座に偽装が解除され、ブロックが消えてプレイヤーが可視化される。

**Why this priority**: 偽装解除メカニクスはゲームバランスの要であり、シーカーが探索する意味を持たせるために必須です。P1と同等の重要度です。

**Independent Test**: 偽装状態のハイダーとして、わずかでも移動（1ブロック未満でも）することで、偽装が即座に解除されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ハイダーが偽装中である、**When** 0.1ブロック以上移動する（WASD キーを押す）、**Then** 即座に偽装ブロックが空気に戻り、プレイヤーが可視化される
2. **Given** ハイダーが偽装中である、**When** ジャンプする、**Then** 偽装が解除される
3. **Given** ハイダーが偽装中である、**When** 視点を動かすだけ（マウス移動）、**Then** 偽装は維持される
4. **Given** ハイダーが偽装解除された、**When** 再度ショップからブロックを選択する、**Then** 新しい位置で再偽装できる
5. **Given** ハイダーが偽装中である、**When** 偽装解除時、**Then** 「BLOCK_BREAK」サウンドと「BLOCK_DUST」パーティクルが表示される

---

### User Story 3 - Capture Through Disguise Block (Priority: P1)

シーカーが偽装ブロックを攻撃することで、ハイダーを捕獲できる。

**Why this priority**: 偽装システムとゲームの捕獲メカニクスを連携させる重要な機能です。これがないとシーカーが偽装中のハイダーを捕獲できません。

**Independent Test**: シーカーとして偽装ブロックを左クリック（攻撃）することで、ハイダーが捕獲され観戦モードに移行することを確認できる。

**Acceptance Scenarios**:

1. **Given** ハイダーが偽装中でシーカーが近くにいる、**When** シーカーが偽装ブロックを左クリック（攻撃）する、**Then** ハイダーは即座に捕獲され観戦モードへ移行する
2. **Given** ハイダーが偽装中である、**When** 偽装ブロックが攻撃される、**Then** 偽装ブロックは消去され（空気に戻る）、全体に捕獲アナウンスが表示される
3. **Given** ハイダーが捕獲された、**When** 捕獲処理が完了する、**Then** シーカーに捕獲報酬（デフォルト200コイン）が付与される
4. **Given** 通常のブロック（環境ブロック）が存在する、**When** シーカーがそのブロックを攻撃する、**Then** 何も起こらない（捕獲されない）

---

### User Story 4 - Visual and Audio Feedback (Priority: P2)

偽装の開始・解除時に適切な視覚・聴覚フィードバックを提供し、プレイヤーに状態変化を明確に伝える。

**Why this priority**: ユーザー体験を向上させるための重要な要素ですが、ゲームの基本メカニクスが動作すればテスト可能です。

**Independent Test**: 偽装の開始と解除を行い、サウンドとパーティクルが正しく再生されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ハイダーがショップでブロックを選択する、**When** 偽装が成功する、**Then** 「ITEM_PICKUP」サウンドと「SPELL_MOB」パーティクルが表示される
2. **Given** ハイダーが偽装中である、**When** 移動して偽装が解除される、**Then** 「BLOCK_BREAK」サウンドと「BLOCK_DUST」パーティクルが表示される
3. **Given** ハイダーが偽装/解除される、**When** 各アクションが実行される、**Then** アクションバーに現在の偽装状態が表示される（「偽装: 石」または「偽装: なし」）

---

### User Story 5 - Disguise State Persistence (Priority: P3)

ゲームの準備フェーズと探索フェーズの間で偽装状態が適切に管理される。

**Why this priority**: ゲームフローの整合性を保つために必要ですが、基本機能が動作すれば後から追加可能です。

**Independent Test**: 準備フェーズ中に偽装を試みたり、ゲーム終了時の状態クリーンアップを確認できる。

**Acceptance Scenarios**:

1. **Given** 準備フェーズ中である、**When** ハイダーがショップで偽装を試みる、**Then** 正常に偽装できる
2. **Given** ゲームが終了する、**When** 終了処理が実行される、**Then** すべての偽装ブロックが空気に戻り、すべてのプレイヤーが可視化される
3. **Given** ハイダーが偽装中である、**When** ゲームが強制終了される、**Then** 偽装状態がクリアされブロックが除去される
4. **Given** プレイヤーが偽装中にゲームから退出する、**When** 退出処理が実行される、**Then** 偽装ブロックが除去される

---

### Edge Cases

- **同一位置の偽装**: 同じ座標に複数のプレイヤーが偽装を試みた場合、最初のプレイヤーのみ成功し、2人目以降はエラーメッセージを受け取る
- **ゲーム外での偽装**: ゲームに参加していないプレイヤーがショップコマンドを実行した場合、アクセスを拒否するエラーメッセージが表示される
- **シーカーの偽装禁止**: シーカーがショップを開いた場合、偽装ブロック選択オプションは表示されない（シーカー専用アイテムのみ表示）
- **ブロック設置不可エリア**: 保護されたエリアや既にブロックが存在する位置では偽装できず、エラーメッセージが表示される
- **移動検出の精度**: サーバーラグやクライアントの遅延により、0.1ブロック未満の微小な移動でも確実に検出される必要がある
- **偽装中の強制移動**: ノックバックやテレポートなど外部要因による移動でも偽装は解除される
- **複数ブロックの連続設置**: プレイヤーが素早く偽装→解除→再偽装を繰り返した場合、各アクションが正しく処理される
- **ゲーム終了時の残存ブロック**: サーバークラッシュやエラーで正常終了しなかった場合でも、次回起動時に残存ブロックが自動クリアされる（または手動クリアコマンドが提供される）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ハイダーがゲーム中に`/hs shop`コマンドでショップGUIを開けるようにしなければならない
- **FR-002**: ショップGUIは、ハイダーに対して選択可能なブロックリスト（石、土、草ブロック、オークの原木、丸石、砂、砂利）を表示しなければならない
- **FR-003**: システムは、ハイダーがブロックを選択した際、プレイヤーの足元（現在位置）に選択したブロックを設置しなければならない
- **FR-004**: システムは、ブロック設置と同時にプレイヤーに完全な透明化効果（不可視ポーション効果）を付与しなければならない
- **FR-005**: システムは、同一座標に既に偽装ブロックが存在する場合、新たな偽装を拒否し、エラーメッセージを表示しなければならない
- **FR-006**: システムは、プレイヤーの移動を監視し、0.1ブロック以上の位置変化を検出した際に偽装を即座に解除しなければならない
- **FR-007**: 偽装解除時、システムは偽装ブロックを空気に戻し、プレイヤーの透明化効果を除去しなければならない
- **FR-008**: システムは、視点移動（マウス操作）のみでは偽装を解除してはならない
- **FR-009**: システムは、シーカーが偽装ブロックを攻撃（左クリック）した際、そのブロックに対応するハイダーを捕獲しなければならない
- **FR-010**: 捕獲時、システムは偽装ブロックを除去し、ハイダーを観戦モードに移行させ、シーカーに捕獲報酬を付与しなければならない
- **FR-011**: システムは、通常の環境ブロック（偽装でないブロック）への攻撃では捕獲処理を実行してはならない
- **FR-012**: システムは、偽装成功時に「ITEM_PICKUP」サウンドと「SPELL_MOB」パーティクルを再生しなければならない
- **FR-013**: システムは、偽装解除時に「BLOCK_BREAK」サウンドと「BLOCK_DUST」パーティクルを再生しなければならない
- **FR-014**: システムは、アクションバーにプレイヤーの現在の偽装状態（ブロック名または「なし」）を表示しなければならない
- **FR-015**: システムは、ゲーム終了時（通常終了・強制終了問わず）にすべての偽装ブロックを空気に戻し、すべてのプレイヤーを可視化しなければならない
- **FR-016**: システムは、プレイヤーがゲームから退出する際、そのプレイヤーの偽装ブロックを除去しなければならない
- **FR-017**: システムは、シーカーがショップを開いた際、偽装ブロック選択オプションを表示してはならない
- **FR-018**: システムは、ゲームに参加していないプレイヤーのショップアクセスを拒否しなければならない
- **FR-019**: システムは、各偽装ブロックの位置と対応するプレイヤーUUIDの紐付けを管理しなければならない
- **FR-020**: システムは、外部要因（ノックバック、テレポートなど）による移動でも偽装を解除しなければならない

### Key Entities

- **DisguiseBlock（偽装ブロック）**: プレイヤーが偽装として設置したブロック。位置座標（Location）、ブロックタイプ（Material）、所有プレイヤー（UUID）、設置時刻を持つ
- **DisguisedPlayer（偽装中プレイヤー）**: 偽装状態のハイダー。プレイヤーUUID、偽装ブロック位置、偽装開始時刻、透明化効果の状態を持つ
- **ShopGUI（ショップGUI）**: プレイヤーに表示されるインベントリベースのGUI。ハイダー用とシーカー用で異なる内容を表示する

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ハイダーがショップからブロックを選択してから偽装状態になるまでの時間が1秒以内である
- **SC-002**: プレイヤーが0.1ブロック以上移動した際、偽装解除が200ミリ秒以内に検出・実行される
- **SC-003**: シーカーが偽装ブロックを攻撃してから捕獲処理が完了するまでの時間が1秒以内である
- **SC-004**: 30人が同時にゲームをプレイし、各ハイダーが偽装を繰り返しても、サーバーTPS（Ticks Per Second）が18以上を維持する
- **SC-005**: ゲーム終了時に、すべての偽装ブロックが5秒以内に除去される
- **SC-006**: 偽装・解除時の視覚・聴覚フィードバック（サウンド、パーティクル）が100%のケースで正しく表示される
- **SC-007**: 同一位置への複数偽装試行が100%の確率で2人目以降を拒否する
- **SC-008**: 偽装システムのメモリ使用量が、プレイヤー1人あたり1MB以下である
- **SC-009**: ハイダーの90%が偽装機能を初回プレイ時に理解し、正常に使用できる
- **SC-010**: 偽装状態の管理において、サーバー再起動後も残存ブロックが0個である（完全なクリーンアップ）

## Assumptions *(optional)*

- ゲームはPaper 1.21.x環境で動作する
- Vaultプラグインが導入済みで、経済システムが利用可能である
- プレイヤーは既にゲームに参加している状態である（ゲーム参加フローは別機能で実装済み）
- ショップGUIの基本構造（インベントリベースのGUI表示システム）は既に実装されている、または同時開発される
- ブロック設置位置はプレイヤーの足元（Y座標はプレイヤーの位置）とする
- 偽装ブロックの当たり判定は通常ブロックと同じである
- 透明化効果はポーション効果（PotionEffect.INVISIBILITY）で実装される
- 移動検出は`PlayerMoveEvent`で実装される
- サーバーのデフォルトTPS目標は20である

## Out of Scope *(optional)*

- 見逃しアイテム（Escape Pass）の実装 - これは別機能として実装される
- シーカー用ショップアイテム（コンパス、スピードブーストなど） - これは別機能として実装される
- 統計システム（プレイヤーの偽装使用回数など） - フェーズ2で実装予定
- 複数ブロック同時偽装（1人で複数のブロックに偽装） - 現仕様では1人1ブロックのみ
- カスタムブロックテクスチャやモデル - バニラMinecraftのブロックのみ使用
- 偽装中の特殊能力（防御力向上など） - 単純な透明化のみ
- AI によるシーカーのサポート機能 - プレイヤーのスキルのみに依存

## Dependencies *(optional)*

- **ゲーム管理システム**: ゲームの状態（準備フェーズ、探索フェーズ、終了）を管理するシステムが必要
- **プレイヤー役割管理**: プレイヤーがハイダーかシーカーかを識別するシステムが必要
- **捕獲システム**: 攻撃による捕獲処理の基本フローが実装されている必要がある
- **経済システム（Vault）**: 捕獲報酬の付与に使用される
- **ショップGUIフレームワーク**: インベントリベースのGUI表示システムが必要
- **観戦モードシステム**: 捕獲されたプレイヤーを観戦モードに移行させる機能が必要

## Related Features *(optional)*

- **見逃しアイテム**: 攻撃された時に自動発動し、捕獲を回避する機能（フェーズ2）
- **シーカー用ショップ**: シーカーが使用できる特殊アイテム（コンパス、スピードブーストなど）（フェーズ2）
- **統計システム**: プレイヤーの偽装使用回数、捕獲数などを記録（フェーズ2）
- **実績システム**: 「完璧な偽装」（一度も移動せずに5分間偽装）などの実績（フェーズ4）

## Notes *(optional)*

- 偽装ブロックは実際のブロックとして設置されるため、視覚的には環境ブロックと区別がつかない。シーカーは記憶力と観察力で偽装を見破る必要がある
- 移動検出の閾値（0.1ブロック）はサーバーラグの影響を受ける可能性があるため、実装時に調整が必要になる場合がある
- パフォーマンス最適化のため、偽装ブロックの管理はHashMap<Location, UUID>で実装し、O(1)の検索速度を維持する
- 日本語と英語の両方のメッセージをサポートする予定（言語ファイルはフェーズ2で実装）
- CLAUDE.mdの仕様に基づき、プレイヤーの元の位置は「空気か液体」であることを前提とするため、ブロック復元処理は不要
