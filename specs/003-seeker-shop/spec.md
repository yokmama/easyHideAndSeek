# Feature Specification: Seeker Shop System (シーカー用ショップシステム)

**Feature Branch**: `003-seeker-shop`
**Created**: 2025-11-03
**Status**: Draft
**Input**: User description: "シーカーのショップを実装してください。　シーカーのショップにはハイダーをみつけやすいtめの便利なアイテムがうっています。　１　数秒間視界が広がる、　２　数秒間　偽装しているブロックが発光する　３　足がはやくなる　４　攻撃範囲が広くなる　などです。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Enhanced Vision Item (Priority: P1)

シーカーがショップから「視界拡大」アイテムを購入し、一定時間視界が広がることでハイダーを見つけやすくなる。

**Why this priority**: シーカーの基本的な探索能力を強化する最も直感的なアイテムです。ゲームバランスを保ちながらシーカーに有利な状況を作り出す核心機能です。

**Independent Test**: シーカーとしてゲームに参加し、ショップから「視界拡大」アイテムを購入して使用することで、視界範囲が通常より広がり、遠くのブロックまで見えることを確認できる。

**Acceptance Scenarios**:

1. **Given** シーカーがゲーム中でショップを開いている、**When** 「視界拡大」アイテムを選択し購入する、**Then** 所持金から価格分が引かれ、アイテムがインベントリに追加される
2. **Given** シーカーが「視界拡大」アイテムを持っている、**When** アイテムを使用（右クリック）する、**Then** 30秒間、視界が拡大する
3. **Given** 視界拡大効果が有効である、**When** 効果時間が終了する、**Then** 視界が通常に戻り、アイテムがインベントリから削除される
4. **Given** 視界拡大効果が有効である、**When** 遠くのブロックを見る、**Then** 通常よりも遠くまで明瞭に見える

---

### User Story 2 - Disguise Block Detection Item (Priority: P1)

シーカーがショップから「偽装ブロック発光」アイテムを購入し、一定時間偽装しているブロックが光ることでハイダーを特定できる。

**Why this priority**: 偽装システムに対する直接的なカウンターメカニクスであり、シーカーに重要な戦略的優位性を提供します。ゲームの核心メカニクスに直結するため最優先です。

**Independent Test**: シーカーとして「偽装ブロック発光」アイテムを購入・使用し、偽装中のハイダーのブロックが光って見えることを確認できる。

**Acceptance Scenarios**:

1. **Given** シーカーがゲーム中でショップを開いている、**When** 「偽装ブロック発光」アイテムを選択し購入する、**Then** 所持金から価格分が引かれ、アイテムがインベントリに追加される
2. **Given** シーカーが「偽装ブロック発光」アイテムを持っている、**When** アイテムを使用する、**Then** 15秒間、視界内の偽装ブロックが発光エフェクトで強調表示される
3. **Given** 発光効果が有効で偽装中のハイダーがいる、**When** シーカーが偽装ブロックの方向を見る、**Then** 偽装ブロックが発光パーティクルで囲まれ、通常のブロックと明確に区別できる
4. **Given** 発光効果が有効である、**When** ハイダーが偽装を解除する、**Then** そのブロックの発光エフェクトが即座に消える
5. **Given** 発光効果が有効である、**When** 効果時間が終了する、**Then** すべての発光エフェクトが消え、アイテムがインベントリから削除される

---

### User Story 3 - Speed Boost Item (Priority: P2)

シーカーがショップから「スピードブースト」アイテムを購入し、一定時間移動速度が上昇することでハイダーを追跡しやすくなる。

**Why this priority**: 探索効率を向上させる重要な機能ですが、視界や検出系アイテムと比べると補助的な役割です。独立してテスト可能で価値を提供します。

**Independent Test**: シーカーとして「スピードブースト」アイテムを購入・使用し、移動速度が上昇することを確認できる。

**Acceptance Scenarios**:

1. **Given** シーカーがゲーム中でショップを開いている、**When** 「スピードブースト」アイテムを選択し購入する、**Then** 所持金から価格分が引かれ、アイテムがインベントリに追加される
2. **Given** シーカーが「スピードブースト」アイテムを持っている、**When** アイテムを使用する、**Then** 30秒間、移動速度が上昇する
3. **Given** スピード効果が有効である、**When** 移動する、**Then** 通常より速く移動できる
4. **Given** スピード効果が有効である、**When** 効果時間が終了する、**Then** 移動速度が通常に戻り、アイテムがインベントリから削除される

---

### User Story 4 - Extended Reach Item (Priority: P2)

シーカーがショップから「攻撃範囲拡大」アイテムを購入し、一定時間攻撃範囲が広がることで遠くからでも偽装ブロックを攻撃できる。

**Why this priority**: 捕獲の効率を高める便利な機能ですが、ゲームの核心メカニクスへの影響は限定的です。P2として実装可能です。

**Independent Test**: シーカーとして「攻撃範囲拡大」アイテムを購入・使用し、通常より遠くから偽装ブロックを攻撃できることを確認できる。

**Acceptance Scenarios**:

1. **Given** シーカーがゲーム中でショップを開いている、**When** 「攻撃範囲拡大」アイテムを選択し購入する、**Then** 所持金から価格分が引かれ、アイテムがインベントリに追加される
2. **Given** シーカーが「攻撃範囲拡大」アイテムを持っている、**When** アイテムを使用する、**Then** 30秒間、攻撃可能距離が通常の1.5倍に拡大する
3. **Given** 攻撃範囲拡大効果が有効である、**When** 通常では届かない距離の偽装ブロックを攻撃する、**Then** 攻撃が成功しハイダーが捕獲される
4. **Given** 攻撃範囲拡大効果が有効である、**When** 効果時間が終了する、**Then** 攻撃範囲が通常に戻り、アイテムがインベントリから削除される

---

### User Story 5 - Shop Access and Economy Integration (Priority: P1)

シーカーが所持金を使ってショップからアイテムを購入し、経済システムと連携する。

**Why this priority**: ショップシステムの基盤機能であり、すべてのアイテム購入に必要です。経済システムとの統合は必須です。

**Independent Test**: シーカーとしてショップを開き、十分な資金がある場合は購入成功、不足している場合はエラーメッセージが表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** シーカーがゲーム中である、**When** `/hs shop`コマンドを実行する、**Then** シーカー専用のショップGUIが開き、4種類のアイテムが表示される
2. **Given** シーカーがショップを開いている、**When** 所持金が不足しているアイテムを選択する、**Then** エラーメッセージが表示され購入できない
3. **Given** シーカーがショップを開いている、**When** 十分な所持金があるアイテムを選択する、**Then** 購入が成功し、所持金が減少してアイテムがインベントリに追加される
4. **Given** シーカーがアイテムを購入した、**When** 同じアイテムを再度購入しようとする、**Then** 制限がなければ再購入可能（クールダウンや購入制限は各アイテムの設定による）

---

### Edge Cases

- **所持金不足**: シーカーの所持金がアイテム価格より少ない場合、エラーメッセージが表示され購入が拒否される
- **インベントリ満杯**: シーカーのインベントリが満杯の場合、アイテムが追加できずエラーメッセージが表示される
- **効果の重複**: 同じ効果を持つアイテムを複数使用した場合、効果時間が延長されるか、または新しい効果で上書きされる（設定による）
- **ゲーム終了時の効果**: ゲームが終了した際、すべてのアクティブな効果が自動的に解除され、未使用アイテムがインベントリから削除される
- **ハイダー用ショップとの分離**: ハイダーがショップを開いた場合、ハイダー用アイテムのみが表示され、シーカー用アイテムは表示されない
- **効果中のロール変更**: 特殊モード（Infection Modeなど）でシーカーがハイダーになった場合、シーカー用アイテムの効果が即座に無効化される
- **視界拡大の視認距離**: 視界拡大効果中に、サーバーの描画距離設定を超える範囲は表示されない（サーバー設定に依存）
- **発光エフェクトの視認性**: 発光エフェクトは参加者全員に見えるのではなく、アイテムを使用したシーカーのみに見える
- **アイテム使用のクールダウン**: 連続使用を防ぐため、各アイテムに使用後のクールダウン時間を設定可能（オプション）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、シーカーがゲーム中に`/hs shop`コマンドでシーカー専用のショップGUIを開けるようにしなければならない
- **FR-002**: ショップGUIは、シーカーに対して4種類のアイテム（視界拡大、偽装ブロック発光、スピードブースト、攻撃範囲拡大）を表示しなければならない
- **FR-003**: システムは、各アイテムに価格、効果時間、アイコン、説明文を設定できるようにしなければならない
- **FR-004**: システムは、シーカーがアイテムを購入する際、所持金が十分かチェックしなければならない
- **FR-005**: 購入成功時、システムは所持金から価格分を引き、アイテムをシーカーのインベントリに追加しなければならない
- **FR-006**: 購入失敗時（所持金不足、インベントリ満杯など）、システムはエラーメッセージを表示しなければならない
- **FR-007**: システムは、「視界拡大」アイテムが使用されたとき、指定時間視界範囲を拡大しなければならない
- **FR-008**: システムは、「偽装ブロック発光」アイテムが使用されたとき、指定時間偽装ブロックに発光エフェクトを表示しなければならない
- **FR-009**: 発光エフェクトは、アイテムを使用したシーカーのみに見えなければならない（他のプレイヤーには見えない）
- **FR-010**: システムは、「スピードブースト」アイテムが使用されたとき、指定時間移動速度を上昇させなければならない
- **FR-011**: システムは、「攻撃範囲拡大」アイテムが使用されたとき、指定時間攻撃可能距離を拡大しなければならない
- **FR-012**: システムは、各アイテムの効果時間が終了したとき、効果を解除し使用済みアイテムをインベントリから削除しなければならない
- **FR-013**: システムは、アイテム使用時に視覚・聴覚フィードバック（サウンド、パーティクル）を提供しなければならない
- **FR-014**: システムは、アクティブな効果の残り時間をアクションバーまたはスコアボードに表示しなければならない
- **FR-015**: システムは、ゲーム終了時にすべてのアクティブ効果を解除し、未使用アイテムをインベントリから削除しなければならない
- **FR-016**: システムは、ハイダーがショップを開いた場合、シーカー用アイテムを表示してはならない
- **FR-017**: システムは、ゲームに参加していないプレイヤーのショップアクセスを拒否しなければならない
- **FR-018**: システムは、各アイテムに購入制限（回数制限、クールダウンなど）を設定できるようにしなければならない
- **FR-019**: システムは、効果が重複した場合の挙動（延長、上書き、拒否）を制御できるようにしなければならない
- **FR-020**: システムは、経済システム（Vault）と連携してアイテム購入時の決済を処理しなければならない

### Key Entities

- **SeekerShopItem（シーカー用ショップアイテム）**: シーカーが購入できるアイテム。アイテム名、価格、効果タイプ（視界拡大、発光、スピード、範囲拡大）、効果時間、アイコン、説明文、購入制限を持つ
- **ActiveEffect（アクティブ効果）**: プレイヤーに適用されている効果。プレイヤーUUID、効果タイプ、開始時刻、終了時刻、効果の強度（倍率など）を持つ
- **ItemPurchaseRecord（アイテム購入記録）**: アイテム購入の履歴。プレイヤーUUID、アイテム名、購入時刻、価格、ゲームセッションIDを持つ（統計・制限管理用）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: シーカーがショップからアイテムを選択してから購入処理が完了するまでの時間が1秒以内である
- **SC-002**: アイテム使用から効果が適用されるまでの時間が500ミリ秒以内である
- **SC-003**: 「偽装ブロック発光」アイテムの使用時、視界内のすべての偽装ブロックが1秒以内に発光表示される
- **SC-004**: 効果時間終了時、200ミリ秒以内に効果が正確に解除される
- **SC-005**: 30人が同時にゲームをプレイし、各シーカーが複数のアイテムを使用しても、サーバーTPSが18以上を維持する
- **SC-006**: アイテム使用時の視覚・聴覚フィードバックが100%のケースで正しく再生される
- **SC-007**: 所持金不足や購入制限違反の検出が100%の精度で行われる
- **SC-008**: ショップシステムのメモリ使用量が、プレイヤー1人あたり500KB以下である
- **SC-009**: シーカーの80%が各アイテムの効果を初回使用時に理解し、戦略的に活用できる
- **SC-010**: 「視界拡大」効果により、シーカーのハイダー発見率が平均20%向上する

## Assumptions *(optional)*

- ゲームはPaper 1.21.x環境で動作する
- Vaultプラグインが導入済みで、経済システムが利用可能である
- プレイヤーは既にゲームに参加している状態である（ゲーム参加フローは実装済み）
- ショップGUIの基本構造（インベントリベースのGUI表示システム）は既に実装されている
- ハイダー用ショップは既に実装されており、役割に応じた表示切り替え機能が存在する
- 偽装システムは既に実装されており、偽装ブロックの位置情報を取得できる
- 視界拡大は視認距離（Render Distance）の調整で実装される
- スピードブーストはポーション効果（Speed）で実装される
- 攻撃範囲拡大は攻撃判定のレイキャスト距離を変更して実装される
- デフォルトの効果時間は30秒とする（設定で変更可能）
- アイテム価格はconfig.ymlで設定可能とする

## Out of Scope *(optional)*

- カスタムアイテムモデルやテクスチャ - バニラMinecraftのアイテムアイコンのみ使用
- PvP戦闘システム - このゲームは捕獲メカニクスのみでダメージは与えない
- アイテムのトレード機能 - プレイヤー間でのアイテム交換は不可
- アイテムの永続化 - ゲーム終了時にすべてのアイテムは削除される
- リアルマネー決済 - ゲーム内通貨のみ使用
- アイテムのアップグレードシステム - 各アイテムは固定の効果を持つ
- ガチャ・ランダム要素 - すべてのアイテムは確定購入
- クラフトシステム - アイテムは購入のみで入手可能

## Dependencies *(optional)*

- **ゲーム管理システム**: ゲームの状態（準備フェーズ、探索フェーズ、終了）を管理するシステムが必要
- **プレイヤー役割管理**: プレイヤーがハイダーかシーカーかを識別するシステムが必要
- **経済システム（Vault）**: アイテム購入時の決済処理に使用される
- **ショップGUIフレームワーク**: インベントリベースのGUI表示システムが必要（既存実装を拡張）
- **偽装システム**: 「偽装ブロック発光」アイテムが偽装ブロックの位置を取得するために必要
- **エフェクト管理システム**: ポーション効果や視覚エフェクトを管理するシステムが必要

## Related Features *(optional)*

- **ハイダー用ショップ**: ハイダーが使用する偽装ブロック選択や見逃しアイテム（既に実装済み）
- **統計システム**: プレイヤーのアイテム使用回数、効果的な使用タイミングなどを記録（フェーズ2）
- **実績システム**: 「完璧な追跡」（視界拡大のみでハイダーを5人捕獲）などの実績（フェーズ4）
- **トーナメントモード**: アイテム使用制限や特殊ルールを設定した競技モード（フェーズ4）

## Notes *(optional)*

- アイテムの価格設定はゲームバランスに大きく影響するため、テストプレイを重ねて調整が必要
- 「偽装ブロック発光」は非常に強力な効果のため、価格を高めに設定し使用頻度を制限することを推奨
- 視界拡大の実装方法（描画距離変更、暗視効果など）は、サーバーパフォーマンスへの影響を考慮して選択する
- 効果の重複処理は、ゲームバランスに影響するため慎重に設計する（延長よりも上書きを推奨）
- アイテム使用のクールダウン機能は、オプションとして実装し、サーバー管理者が設定可能にする
- 日本語と英語の両方のメッセージをサポートする予定（言語ファイルはフェーズ2で実装）
